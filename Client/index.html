<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-68J35F2R6N"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'G-68J35F2R6N');
	</script>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Playlist Heardle | ArjhanToteck</title>
	<link href="/style.css" rel="stylesheet" type="text/css" media="all">
	<link rel="icon" href="/favicon.png">

	<style>
		.audioContainer {
			width: 75%;
			background-color: gray;
			border-radius: 4px;
		}

		.audioProgress, .audioSegment {
			width: 0px;
			height: 20px;
			border-radius: 4px;
			text-align: center;
			line-height: 30px;
			font-weight: bold;
			transition: width 0.3s ease-in-out;
		}

		.audioProgress {
			position: absolute;
			background-color: white;
		}

		.audioSegment {
			background-color: #c2c2c2;
		}

		.audioProgressText {
			margin-top:5px;
			font-size: 12px;
		}
	</style>
</head>

<h1 class="glitch" data-text="Playlist Heardle">Playlist Heardle</h1>

<br>
<br>
<div id="menu">
	Enter a playlist link and guess a random song from it.

	<br>
	<br>

	<input id="playlistLink" placeholder="Spotify playlist link" size="30">
	<br>
	<br>
	<button id="playButton" onclick="play()">Play</button>
	<br>
	<br>
	<div id="loading" style="display:none">Loading...</div>
	<br>
</div>

<div id="game" style="display:none">
	game

	<br>
	<br>

	<div class="audioContainer" id="audioContainer">
		<audio autoplay="true" id="audio"></audio>
		<div class="audioSegment" id="audioSegment">
			<div class="audioProgress" id="audioProgress"></div>
		</div>
	</div>
	<div class="audioProgressText" id="audioProgressText">0:00/0:30</div>

</div>

<script>
	const server = "https://playlist-heardle.arjhantoteck.repl.co";

	const segments = [1, 2, 4, 7, 11, 16];

	function play() {
		let playlistLink = document.getElementById("playlistLink");
		let playButton = document.getElementById("playButton");
		playlistLink.disabled = true;
		playButton.disabled = true;

		// show loading indicator
		document.getElementById("loading").style.display = "block";

		// get playlist id from provided url
		let playlistId = playlistLink.value.split("playlist/")[1].split("?")[0];

		// make request for game data
		fetch(server + "/playlist?" + playlistId)
			.then(res => res.json())
			.then(data => {
			// get audioUrl
			let audioUrl = server + "/callback?" + encodeURIComponent(data.callback);

			// set audioUrl to audioElement for play
			let audioElement = document.getElementById("audio");
			audioElement.src = audioUrl;

			// wait for audio to load
			audioElement.addEventListener('loadedmetadata', function() {
				document.getElementById("game").style.display = "block";
				document.getElementById("menu").style.display = "none";

				// play audio when loaded
				audioElement.play();

				let audioProgress = document.getElementById("audioProgress");
				let audioSegment = document.getElementById("audioSegment");
				let audioProgressText = document.getElementById("audioProgressText");

				// max time is 30 seconds, limit starts at 1
				const duration = segments[segments.length - 1];
				let currentLimit = segments[0];
				setAudioSegment();

				function setAudioSegment(){
					let percentage = (currentLimit / duration) * 100;
					audioSegment.style.width = percentage + "%";
				}

				audioElement.addEventListener('timeupdate', function() {
					// calculate progress
					let currentTime = audioElement.currentTime;
					let containerWidth = document.getElementById("audioContainer").offsetWidth;

					if (currentTime >= currentLimit) {
						audioElement.pause();
						currentTime = currentLimit;
						console.log("pause time");
					}

					let percentage = (currentTime / duration) * 100;

					// calculate width relative to audioContainer
					let progressWidth = (percentage / 100) * containerWidth;

					// set progress indicator
					audioProgress.style.width = progressWidth + "px";
					audioProgressText.innerText = formatTimeString(currentTime) + "/" + formatTimeString(duration);
				});
			});
		});
	}

	function formatTimeString(time){
		// format time string
		const date = new Date(0);
		date.setSeconds(time);
		return date.toISOString().substring(14, 19);
	}
</script>